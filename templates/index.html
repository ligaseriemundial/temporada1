<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Liga Serie Mundial online - Tabla & Juegos</title>
  <!-- Sirve el CSS desde /static; aseg√∫rate de tener static/styles.css con contenido -->
  <link rel="stylesheet" href="/static/styles.css" />
  <style>
    /* Fallback visual m√≠nimo por si el CSS no carga */
    body{font-family:system-ui,Arial,sans-serif;background:#0b1220;color:#e8eefc;margin:0}
    .container{max-width:1000px;margin:0 auto;padding:24px}
    .hidden{display:none}
    .table-wrapper{overflow:auto;background:#121a2b;border-radius:12px;padding:12px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px 8px;border-bottom:1px solid rgba(255,255,255,.08)}
    th{color:#9fb3d1;font-weight:600;font-size:13px;text-align:left}
    td{font-size:14px}
    .num{text-align:right}
    .tag{background:rgba(77,163,255,.12);color:#cfe5ff;padding:2px 8px;border-radius:999px;font-size:12px}
    .muted{color:#9fb3d1}
    .pill{font-size:12px;color:#9fb3d1}
    .games-list{list-style:none;padding:0;margin:0}
    .games-list li{padding:10px 8px;border-bottom:1px solid rgba(255,255,255,.08)}
    #error{background:#2a0f13;border:1px solid #4b151b;color:#ffb3b8;padding:10px 12px;border-radius:8px;margin:10px 0}
    #loading{color:#9fb3d1;margin:8px 0}
  </style>
</head>
<body>
  <div class="container">
    <h1>‚öæ Liga Serie Mundial </h1>
    <p class="muted">Tabla de posiciones y juegos del d√≠a</p>

    <div id="loading">Cargando datos, por favor espera‚Ä¶</div>
    <div id="error" class="hidden"></div>
    <div id="last-updated" class="muted hidden"></div>

    <section id="standings-section" class="hidden">
      <h2>üèÜ Tabla de posiciones</h2>
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>Equipo</th>
              <th>Jugador</th>
              <th class="num">Prog</th>
              <th class="num">JJ</th>
              <th class="num">JG</th>
              <th class="num">JP</th>
              <th class="num">Por jugar</th>
              <th class="num">...</th>
            </tr>
          </thead>
          <tbody id="standings-body"></tbody>
        </table>
      </div>
    </section>

    <section id="games-today-section" class="hidden">
      <h2>üìÖ Juegos jugados hoy</h2>
      <ul id="games-today-list" class="games-list"></ul>
    </section>

    <!-- ===================== -->
    <!-- JUEGOS POR SEMANA -->
    <!-- ===================== -->
    <section id="weekly-section" class="hidden">
      <h2>üìÖ Juegos por semana</h2>

      <label for="weekly-filter">Filtrar por equipo:</label>
      <select id="weekly-filter"></select>

      <div id="weekly-container"></div>
    </section>

  </div>

  <script>
    const el = {
      loading: document.getElementById('loading'),
      error: document.getElementById('error'),
      updated: document.getElementById('last-updated'),
      standingsSection: document.getElementById('standings-section'),
      standingsBody: document.getElementById('standings-body'),
      gamesSection: document.getElementById('games-today-section'),
      gamesList: document.getElementById('games-today-list')
    };
    const show = x => x.classList.remove('hidden');
    const hide = x => x.classList.add('hidden');

    
    function renderWeekly(data){
      const weekly = data.semanas;
      const current = data.semana_actual;
      const cont = document.getElementById('weekly-container');
      const filter = document.getElementById('weekly-filter');
      cont.innerHTML = '';
      filter.innerHTML = '';

      if (!weekly || !current) return;

      // Build unique team list for filter
      const teamsSet = new Set();
      Object.values(weekly).forEach(arr => {
        arr.forEach(j => { teamsSet.add(j.local); teamsSet.add(j.visitante); });
      });
      const teams = Array.from(teamsSet).sort();
      const mkOpt = (val, text) => { const o = document.createElement('option'); o.value = val; o.textContent = text; return o; };
      filter.appendChild(mkOpt('Todos','Todos'));
      teams.forEach(t => filter.appendChild(mkOpt(t, t)));

      const createWeekBlock = (weekNum, juegos) => {
        // Group by series key "local vs visitante"
        const groups = {};
        juegos.forEach((j, idx) => {
          const key = j.local + ' vs ' + j.visitante;
          if (!groups[key]) groups[key] = [];
          groups[key].push({idx: idx+1, ...j});
        });

        const details = document.createElement('details');
        if (String(weekNum) === String(current)) details.open = true;
        const summary = document.createElement('summary');
        summary.textContent = 'Semana ' + weekNum + (String(weekNum) === String(current) ? ' (ACTUAL)' : '');
        details.appendChild(summary);

        Object.entries(groups).forEach(([serie, juegosSerie]) => {
          const title = document.createElement('h3');
          title.className = 'titulo-serie';
          title.textContent = 'Serie: ' + serie;
          details.appendChild(title);

          const ul = document.createElement('ul');
          ul.className = 'serie-lista';

          juegosSerie.forEach(j => {
            const li = document.createElement('li');
            li.className = 'juego-linea ' + ('estado-' + (j.estado||'').toLowerCase());
            const result = j.resultado && j.resultado.trim() !== '' ? j.resultado : '-';
            li.textContent = `Juego ${j.idx} ‚Äî ${j.local} vs ${j.visitante} ‚Äî ${result} (${j.estado})`;
            ul.appendChild(li);
          });

          details.appendChild(ul);
        });

        return details;
      };

      Object.entries(weekly).forEach(([week, juegos]) => {
        cont.appendChild(createWeekBlock(week, juegos));
      });

      function applyWeeklyFilter(){
        const sel = filter.value;
        const lines = cont.querySelectorAll('.juego-linea, .titulo-serie');
        if (sel === 'Todos') {
          lines.forEach(x => x.style.display = '');
          return;
        }
        // Hide everything, show only series/items containing team
        lines.forEach(x => x.style.display = 'none');
        cont.querySelectorAll('details').forEach(det => {
          // For each series title + its lis, decide visibility
          const blocks = det.querySelectorAll('.titulo-serie');
          blocks.forEach(title => {
            const serieText = title.textContent || '';
            const ul = title.nextElementSibling;
            let any = false;
            ul.querySelectorAll('.juego-linea').forEach(li => {
              if (li.textContent.includes(sel)) {
                li.style.display = '';
                any = true
              } else {
                li.style.display = 'none';
              }
            });
            if (serieText.includes(sel) || any) {
              title.style.display = '';
              ul.style.display = '';
            } else {
              title.style.display = 'none';
              ul.style.display = 'none';
            }
          });
        });
      }
      filter.onchange = applyWeeklyFilter;
      show(document.getElementById('weekly-section'));
    }

    function parseGameString(s){
      // Convierte "Mets 3 - Mariners 0 - 07-09-2025 - 6:30 pm (hora Chile)"
      const norm = (s||'').replace(/\s+/g,' ').trim();
      const parts = norm.split(' - ');
      if (parts.length >= 4) {
        const [homePart, awayPart, datePart, timePart] = parts;
        const splitLast = (txt) => {
          const i = txt.lastIndexOf(' ');
          if (i === -1) return { name: txt, score: '' };
          return { name: txt.slice(0,i), score: txt.slice(i+1) };
        };
        const h = splitLast(homePart);
        const a = splitLast(awayPart);
        return {
          home_team: h.name,
          home_score: h.score,
          away_team: a.name,
          away_score: a.score,
          ended_at_local: `${datePart} - ${timePart}`
        };
      }
      return { raw: s };
    }

    async function loadData(){
      hide(el.error);
      show(el.loading);
      try{
        const r = await fetch('/api/full', {cache:'no-store'});
        if(!r.ok){
          let msg = `HTTP ${r.status}`;
          try{ const j = await r.json(); if (j && j.error) msg = j.error; }catch(_){}
          throw new Error(msg);
        }
        const data = await r.json();

        // √öltima actualizaci√≥n (si tu app la a√±ade)
        if (data.last_updated) {
          el.updated.textContent = `√öltima actualizaci√≥n: ${data.last_updated}`;
          show(el.updated);
        }

        // Standings
        el.standingsBody.innerHTML = '';
        (data.standings || []).forEach((row, i) => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${i+1}</td>
            <td>${row.team}</td>
            <td><span class="tag">${row.user}</span></td>
            <td class="num">${row.scheduled}</td>
            <td class="num">${row.played}</td>
            <td class="num">${row.wins}</td>
            <td class="num">${row.losses}</td>
            <td class="num">${row.remaining}</td>
            <td class="num">${row.points}</td>
          `;
          el.standingsBody.appendChild(tr);
        });
        show(el.standingsSection);

        // Juegos de hoy (acepta strings u objetos)
        el.gamesList.innerHTML = '';
        const games = data.games_today || [];
        if (games.length === 0) {
          el.gamesList.innerHTML = `<li class="muted">No hay juegos finalizados hoy.</li>`;
        } else {
          games.forEach(g => {
            let obj = g;
            if (typeof g === 'string') obj = parseGameString(g);
            const li = document.createElement('li');
            if (obj.raw) {
              li.textContent = obj.raw;
            } else {
              li.innerHTML = `
                <div><strong>${obj.home_team}</strong> ${obj.home_score} - ${obj.away_score} <strong>${obj.away_team}</strong></div>
                <div class="pill">${obj.ended_at_local}</div>
              `;
            }
            el.gamesList.appendChild(li);
          });
        }
        show(el.gamesSection);

        // Render weekly block if present
        if (data.semanas && data.semana_actual) {
          renderWeekly(data);
        }


      }catch(e){
        el.error.textContent = 'No se pudieron cargar los datos: ' + e.message;
        show(el.error);
      }finally{
        hide(el.loading);
      }
    }

    loadData();
  </script>
</body>
</html>



